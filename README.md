
# Система команд

Данная система команд предназначена для использования с ботом, поддерживающим различные типы чатов, параметры, права доступа, кулдаун и другие функциональные требования. Она предоставляет возможность динамической загрузки и обновления команд, что делает её гибкой и масштабируемой.

## Оглавление

- [Основные компоненты](#основные-компоненты)
- [Создание команды](#создание-команды)
- [Параметры команды](#параметры-команды)
- [Методы обработки](#методы-обработки)
- [Динамическая загрузка команд](#динамическая-загрузка-команд)
- [Пример использования](#пример-использования)
- [Логирование](#логирование)

## Основные компоненты

### `Command.js`

Этот файл содержит базовый класс `Command`, который отвечает за выполнение команд. Он включает:

- Проверку аргументов (`argsCount`)
- Проверку прав доступа (`permissions`)
- Обработку различных типов чатов (`allowedChatTypes`)
- Управление кулдауном и другими настройками.

### `commandsRegistry.js`

Отвечает за динамическую загрузку команд из файловой системы. Использует библиотеку `chokidar` для отслеживания изменений в файлах команд и автоматического их обновления.

### Папка `commands/`

Все команды хранятся в этой директории. Каждая команда — это отдельный файл, который наследует класс `Command`.

## Создание команды

Для создания новой команды необходимо унаследовать базовый класс `Command`. Пример создания команды, которая отвечает "Привет!" пользователю:

```javascript
const Command = require('../Command');

class HelloCommand extends Command {
    constructor() {
        super({
            name: 'hello',
            argsCount: 0,
            permissions: 'user',
            allowedChatTypes: ['global', 'private'],
            cooldown: 5000,
        });
    }

    async handler(bot, typeChat, username, ...args) {
        bot.sendMessage(typeChat, `Привет, ${username}!`);
    }
}

module.exports = HelloCommand;
```

Эта команда принимает ноль аргументов, не требует особых прав доступа и может использоваться как в глобальном, так и в приватном чате. Время кулдауна — 5 секунд.

## Параметры команды

При создании команды можно настроить следующие параметры:

- `name` — имя команды (обязательно).
- `argsCount` — минимальное количество аргументов (по умолчанию 0).
- `permissions` — требуемые права для выполнения команды (по умолчанию '').
- `allowedChatTypes` — типы чатов, в которых команда может быть выполнена (например, 'global', 'private').
- `requirementTime` — дополнительное время ожидания для выполнения команды (по умолчанию 0).
- `cooldown` — время кулдауна между выполнениями команды (по умолчанию 0).
- `isActive` — флаг, указывающий, активна ли команда (по умолчанию `true`).
- `variations` — альтернативные имена для команды.

## Методы обработки

Каждая команда может переопределять стандартные методы для кастомизации поведения. Вот список методов, которые можно настроить:

- `handler(bot, typeChat, username, ...args)` — основной метод выполнения команды.
- `onInvalidArguments(bot, typeChat, username)` — вызывается, если команда получает недостаточное количество аргументов.
- `onInvalidChatType(bot, typeChat, username)` — вызывается, если команда вызывается в неподдерживаемом типе чата.
- `onInsufficientPermissions(bot, typeChat, username)` — вызывается, если у пользователя недостаточно прав.
- `onAdditionalRequirementsNotMet(bot, typeChat, username)` — вызывается, если не выполнены дополнительные требования.
- `onCommandNotActive(bot, typeChat, username)` — вызывается, если команда неактивна.
- `onBlacklisted(bot, typeChat, username)` — вызывается, если пользователь в черном списке.
- `onError(bot, typeChat, username, error)` — вызывается при возникновении ошибки.

### Пример метода `handler`

```javascript
async handler(bot, typeChat, username, ...args) {
    bot.sendMessage(typeChat, `Вы вызвали команду ${this.name}, ${username}!`);
}
```

## Динамическая загрузка команд

Команды загружаются динамически из папки `commands/`. Если вы добавляете или изменяете команду, изменения автоматически применяются, без необходимости перезапуска бота.

Для этого используется библиотека [chokidar](https://github.com/paulmillr/chokidar), которая следит за изменениями в файловой системе и обновляет команды.

## Пример использования

1. Добавьте команду в папку `commands/`, например, `test.js`:

   ```javascript
   const Command = require('../Command');

   class TestCommand extends Command {
       constructor() {
           super({
               name: 'test',
               argsCount: 0,
               permissions: 'admin',
               allowedChatTypes: ['global'],
               cooldown: 1000,
           });
       }

       async handler(bot, typeChat, username, ...args) {
           bot.sendMessage(typeChat, `Команда test выполнена, ${username}!`);
       }
   }

   module.exports = TestCommand;
   ```

2. После запуска бота команда будет загружена и доступна для выполнения в чате.

## Логирование

Для логирования используется библиотека [winston](https://github.com/winstonjs/winston). Все действия, такие как загрузка команд и ошибки, записываются в следующие файлы:

- `commands.log` — информация о загруженных командах.
- `commands-error.log` — ошибки, связанные с загрузкой и выполнением команд.

Пример лога:

```
info: Команда test загружена.
error: Ошибка при загрузке команды из файла hello.js: Cannot find module '../HelloCommand'
```
